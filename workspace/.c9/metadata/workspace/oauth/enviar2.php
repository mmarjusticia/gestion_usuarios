{"changed":true,"filter":false,"title":"enviar2.php","tooltip":"/oauth/enviar2.php","ace":{"folds":[],"scrolltop":857.2727086918417,"scrollleft":0,"selection":{"start":{"row":57,"column":63},"end":{"row":57,"column":63},"isBackwards":false},"options":{"guessTabSize":true,"useWrapMode":false,"wrapToView":true},"firstLineState":0},"value":"<?php\n\nrequire '../clases/AutoCarga.php';\n$bd=new DataBase();\n$gestor=new ManageUsuario($bd);\n$sesion = new Session();\n$emailOld=$sesion->get('_Email');\n$email=  Request::post('email');\n\n$consulta=$gestor->get($email)->getEmail();\nif($consulta!=null){\n    echo 'No puede usar este de correo porque ya existe un usuario para este email';\n}\nelse{  echo 'Ha recibido un email a su nuevo correo electronico. Por favor, reviselo para poder continuar' ;\n        $origen=\"mmarjusticia@gmail.com\";\n        $destino=$email;\n        \n        $usuarioOld=$gestor->get($emailOld);\n        $alias=$usuarioOld->getAlias();\n        $claveCifrada=$usuarioOld->getClave();\n        $sha1=  sha1($destino.Constant::SEMILLA);\n        $fechaAlta=$usuarioOld->getFechaAlta();\n        $administrador=$usuarioOld->getAdministrador();\n        $personal=$usuarioOld->getPersonal();\n//$sesion->set('_email', $destino);\n        $usuario= new Usuario($email,$claveCifrada,$alias,$fechaAlta,0,$administrador,$personal);\n        //$gestor->delete($emailOld);\n        $gestor->set2($usuario);\n        \n        \n        $asunto=\"Validación\";\n        $mensaje=\"Confirme su registro a BD_MMar pulsando el siguiente enlace: \".\"https://gestiondeusuarios-mmarjusticia.c9users.io/oauth/activar.php?email=$destino&sha1=$sha1\";\n        require_once '../clases/Google/autoload.php';\n        require_once '../clases/class.phpmailer.php';  //las últimas versiones también vienen con autoload\n        $cliente = new Google_Client();\n        $cliente->setApplicationName('enviarCorreoDesdeGmail');\n        $cliente->setClientId('505098225843-sdiumqfakj929lle3rugldjv72ojkpgi.apps.googleusercontent.com');\n        $cliente->setClientSecret('dvjJ435G5shs2um5ZG_vVeBs');\n        $cliente->setRedirectUri('https://practicausuario-mmarjusticia.c9users.io/oauth/guardar.php');\n        $cliente->setScopes('https://www.googleapis.com/auth/gmail.compose');\n        $cliente->setAccessToken(file_get_contents('token.conf'));\n        if ($cliente->getAccessToken()) {\n             $service = new Google_Service_Gmail($cliente);\n            try {\n                $mail = new PHPMailer();\n                $mail->CharSet = \"UTF-8\";\n                $mail->From = $origen;\n                $mail->FromName = $alias;\n                $mail->AddAddress($destino);\n                $mail->AddReplyTo($origen, $alias);\n                $mail->Subject = $asunto;\n                $mail->Body = $mensaje;\n                $mail->preSend();\n                $mime = $mail->getSentMIMEMessage();\n                $mime = rtrim(strtr(base64_encode($mime), '+/', '-_'), '=');\n                $mensaje = new Google_Service_Gmail_Message();\n                $mensaje->setRaw($mime);\n                $service->users_messages->send('me', $mensaje);\n                } catch (Exception $e) {\n                        print($e->getMessage());\n                }   \n            }\n        else{\n            echo'error en el envio';\n            }}\n\n       \n","undoManager":{"mark":2,"position":2,"stack":[[{"start":{"row":7,"column":32},"end":{"row":8,"column":0},"action":"remove","lines":["",""],"id":2}],[{"start":{"row":7,"column":32},"end":{"row":8,"column":0},"action":"remove","lines":["",""],"id":3}],[{"start":{"row":7,"column":32},"end":{"row":8,"column":0},"action":"remove","lines":["",""],"id":4}],[{"start":{"row":58,"column":16},"end":{"row":58,"column":90},"action":"insert","lines":["   <div class=\"opcion\"> <a href=\"cerrarSesion.php\">Cerrar Sesión</a></div>"],"id":6}],[{"start":{"row":57,"column":63},"end":{"row":58,"column":0},"action":"insert","lines":["",""],"id":6},{"start":{"row":58,"column":0},"end":{"row":58,"column":16},"action":"insert","lines":["                "]}]]},"timestamp":1453057748000}